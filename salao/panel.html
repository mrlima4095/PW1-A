<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Painel — VittaBeauty</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>  
        body { font-family: 'Inter', sans-serif; background: #f7f7fb; }
        .panel-card { max-width: 900px; margin: 40px auto; background: #fff; border-radius: 16px; padding: 30px; box-shadow: 0 10px 30px rgba(15,15,35,0.06); }
        .btn-primary { background-color: #7E57C2 !important; border-color: #7E57C2 !important; }
        .btn-outline-secondary { border-color: #4CAF50; color: #4CAF50; }
        .btn-outline-secondary:hover { background-color: #4CAF50; color: white; }

        #mailIcon {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #7E57C2;
            color: white;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        #messagesPopup {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 250px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            padding: 15px;
            display: none;
            z-index: 1000;
        }

        #messagesPopup h6 {
            margin: 0 0 10px 0;
            font-weight: bold;
        }

        #messagesPopup p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="mailIcon"><i class="bi bi-envelope-fill"></i></div>
    <div id="messagesPopup">
        <h6>Mensagens</h6>
        <p>Sem mensagens</p>
    </div>

    <div class="panel-card">
        <div class="text-center mb-4">
            <img src="icon.png" alt="Logo" class="mb-3" style="width:60px; height:60px; border-radius:12px;">
            <h1><span>VITTA</span> <span class="fw-bold">BEAUTY</span></h1>
            <p class="text-muted">Olá, <span id="userName"></span></p>
        </div>
        <div class="d-flex gap-2">
            <a href="index.html" class="btn btn-outline-secondary w-50 fw-bold">Voltar</a>
            <button class="btn btn-primary w-50" data-bs-toggle="modal" data-bs-target="#agendarModal">Agendar</button>
            <button class="btn btn-danger w-50" onclick="deslogar()">Sair</button>
        </div>
        <table class="table table-striped mt-4" id="agendaTable">
            <thead>
                <tr>
                    <th>Serviço</th>
                    <th>Data e Hora</th>
                    <th>Usuário</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="modal fade" id="agendarModal" tabindex="-1" aria-labelledby="agendarModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="agendarModalLabel">Agendar Atendimento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <form id="reservaForm">
                        <div id="workerEmailField" class="mb-3" style="display:none;">
                            <label for="clientEmail" class="form-label">Email do Cliente</label>
                            <input type="email" class="form-control" id="clientEmail" placeholder="cliente@exemplo.com">
                        </div>
                        <div class="mb-3">
                            <label for="service" class="form-label">Serviço</label>
                            <select class="form-control" id="service" required>
                                <option value="">Selecione um serviço</option>
                                <option value="Corte + Finalização">Corte + Finalização</option>
                                <option value="Coloração + Tratamento">Coloração + Tratamento</option>
                                <option value="Manicure + Esmaltação">Manicure + Esmaltação</option>
                                <option value="Limpeza de Pele">Limpeza de Pele</option>
                                <option value="Massagem Relax">Massagem Relax</option>
                                <option value="Pacote SPA Completo">Pacote SPA Completo</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="datetime" class="form-label">Data e Hora</label>
                            <input type="datetime-local" class="form-control" id="datetime" required>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-secondary w-50" data-bs-dismiss="modal">Voltar</button>
                            <button type="submit" class="btn btn-primary w-50">Agendar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script>
        let userRole = "user";

        async function carregarAgendas() {
            try {
                const res = await fetch('/aps/painel', { credentials: 'include' });
                if (!res.ok) { throw res; }
                const data = await res.json();

                document.getElementById("userName").textContent = data.name;
                userRole = data.role;

                if (userRole === "worker") { document.getElementById("workerEmailField").style.display = "block"; }

                const tbody = document.querySelector('#agendaTable tbody');
                tbody.innerHTML = '';

                data.agendas.forEach(a => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${a.service}</td>
                        <td>${new Date(a.datetime).toLocaleString('pt-BR')}</td>
                        <td>${a.user_email}</td>
                        <td>
                            <button class="btn btn-outline-secondary btn-sm" onclick="remarcar(${a.id})">Remarcar</button>
                            <button class="btn btn-danger btn-sm" onclick="cancelar(${a.id})">Cancelar</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                Swal.fire({ icon: 'error', title: 'Erro', text: 'Não foi possível carregar os agendamentos. Faça login.' }).then(() => window.location.href = 'login.html');
            }
        }

        async function remarcar(id) {
            const { value: datetime } = await Swal.fire({
                title: 'Escolha nova data e hora',
                input: 'datetime-local',
                showCancelButton: true,
            });
            if (!datetime) { return; }

            try {
                const res = await fetch('/aps/remarcar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ id, datetime })
                });
                const data = await res.json();
                if (res.ok) {
                    Swal.fire({ icon: 'success', title: 'Remarcado!', text: data.response });
                    carregarAgendas();
                } else { Swal.fire({ icon: 'error', title: 'Erro', text: data.response }); }
            } catch (err) { Swal.fire({ icon: 'error', title: 'Erro', text: 'Não foi possível conectar ao servidor.' }); }
        }

        async function cancelar(id) {
            const confirm = await Swal.fire({
                title: 'Tem certeza?',
                text: 'Você quer cancelar este agendamento?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sim, cancelar',
                cancelButtonText: 'Não'
            });
        
            if (!confirm.isConfirmed) return;
        
            try {
                const res = await fetch('/aps/cancelar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ id })
                });
                const data = await res.json();
        
                if (res.ok) {
                    Swal.fire({ icon: 'success', title: 'Cancelado!', text: data.response });
                    carregarAgendas();
                } 
                else { Swal.fire({ icon: 'error', title: 'Erro', text: data.response }); }
            } catch (err) { Swal.fire({ icon: 'error', title: 'Erro', text: 'Falha ao conectar ao servidor.' }); }
        }

        async function verificarLogin() {
            const res = await fetch('/aps/check', { credentials: 'include' });
            if (!res.ok) { window.location.href = 'login.html'; }
        }

        async function deslogar() {
            try {
                const res = await fetch('/aps/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await res.json();
                if (res.ok) { Swal.fire({ icon: 'success', title: 'VittaBeauty', text: "Você foi desconectado!" }).then(() => window.location.href = 'login.html'); } 
                else { Swal.fire({ icon: 'error', title: 'Erro', text: data.response }); }
            } catch (err) { Swal.fire({ icon: 'error', title: 'Erro', text: 'Falha ao desconectar.' }); }
        }

        document.getElementById("reservaForm").addEventListener("submit", async function(e) {
            e.preventDefault();

            const service = document.getElementById("service").value;
            const datetime = document.getElementById("datetime").value;
            const clientEmail = userRole === "worker" ? document.getElementById("clientEmail").value : null;

            try {
                const response = await fetch("/aps/agendar", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ service, datetime, clientEmail }),
                    credentials: "include"
                });

                const data = await response.json();

                if (response.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Agendamento realizado!',
                        text: data.response,
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        var modal = bootstrap.Modal.getInstance(document.getElementById('agendarModal'));
                        modal.hide();
                        carregarAgendas();
                    });
                } else {
                    let mensagem = data.response || "Ocorreu um erro. Tente novamente.";
                    Swal.fire({ icon: 'error', title: 'Erro ao agendar', text: mensagem });
                }
            } catch (err) {
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'Não foi possível conectar ao servidor. Verifique sua conexão e tente novamente.'
                });
            }
        });

        document.getElementById("mailIcon").addEventListener("click", () => {
            const popup = document.getElementById("messagesPopup");
            popup.style.display = (popup.style.display === "block") ? "none" : "block";
        });

        window.addEventListener("click", function(e) {
            const popup = document.getElementById("messagesPopup");
            const mailIcon = document.getElementById("mailIcon");
            if (!popup.contains(e.target) && !mailIcon.contains(e.target)) {
                popup.style.display = "none";
            }
        });

        window.onload = async () => { await verificarLogin(); carregarAgendas(); };
    </script>
</body>
</html>
