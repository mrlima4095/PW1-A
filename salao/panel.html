<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Painel — VittaBeauty</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #f7f7fb; }
        .panel-card { max-width: 900px; margin: 40px auto; background: #fff; border-radius: 16px; padding: 30px; box-shadow: 0 10px 30px rgba(15,15,35,0.06); }
        .btn-primary { background-color: #7E57C2 !important; border-color: #7E57C2 !important; }
        .btn-outline-secondary { border-color: #4CAF50; color: #4CAF50; }
        .btn-outline-secondary:hover { background-color: #4CAF50; color: white; }
    </style>
</head>
<body>
    <div class="panel-card">
        <div class="text-center mb-4">
            <img src="icon.png" alt="Logo" class="mb-3" style="width:60px; height:60px; border-radius:12px;">
            <h1><span>VITTA</span> <span class="fw-bold">BEAUTY</span></h1>
            <p class="text-muted">Olá, <span id="userName"></span></p>
        </div>
        <div class="d-flex gap-2">
            <a href="index.html" class="btn btn-outline-secondary w-50 fw-bold">Voltar</a>
            <a href="agendar.html" class="btn btn-primary w-50">Agendar</a>
            <button class="btn btn-danger w-50" onclick="deslogar()">Sair</button>
        </div>
        <table class="table table-striped" id="agendaTable">
            <thead>
                <tr>
                    <th>Serviço</th>
                    <th>Data e Hora</th>
                    <th>Usuário</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        async function carregarAgendas() {
            try {
                const res = await fetch('/aps/painel', { credentials: 'include' });
                if (!res.ok) throw res;
                const data = await res.json();
        
                document.getElementById("userName").textContent = data.name;
        
                const tbody = document.querySelector('#agendaTable tbody');
                tbody.innerHTML = '';
        
                data.agendas.forEach(a => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${a.service}</td>
                        <td>${new Date(a.datetime).toLocaleString('pt-BR')}</td>
                        <td>${a.user_email}</td>
                        <td>
                            ${
                                data.role === 'worker'
                                    ? `<button class="btn btn-outline-secondary btn-sm" onclick="remarcar(${a.id})">Remarcar</button>`
                                    : `<button class="btn btn-danger btn-sm" onclick="cancelar(${a.id})">Cancelar</button>`
                            }
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                Swal.fire({ icon: 'error', title: 'Erro', text: 'Não foi possível carregar os agendamentos. Faça login.' })
                    .then(() => window.location.href = 'login.html');
            }
        }


        async function remarcar(id) {
            const { value: datetime } = await Swal.fire({
                title: 'Escolha nova data e hora',
                input: 'datetime-local',
                showCancelButton: true,
            });
            if (!datetime) return;

            try {
                const res = await fetch('/aps/remarcar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ id, datetime })
                });
                const data = await res.json();
                if (res.ok) {
                    Swal.fire({ icon: 'success', title: 'Remarcado!', text: data.response });
                    carregarAgendas();
                } else {
                    Swal.fire({ icon: 'error', title: 'Erro', text: data.response });
                }
            } catch (err) {
                Swal.fire({ icon: 'error', title: 'Erro', text: 'Não foi possível conectar ao servidor.' });
            }
        }
        async function verificarLogin() {
            const res = await fetch('/aps/check', { credentials: 'include' });
            if (!res.ok) {
                window.location.href = 'login.html';
            }
        }
        async function deslogar() {
            try {
                const res = await fetch('/aps/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await res.json();
                if (res.ok) {
                    Swal.fire({ icon: 'success', title: 'VittaBeauty', text: "Você foi desconectado!" })
                        .then(() => window.location.href = 'login.html');
                } else {
                    Swal.fire({ icon: 'error', title: 'Erro', text: data.response });
                }
            } catch (err) {
                Swal.fire({ icon: 'error', title: 'Erro', text: 'Falha ao desconectar.' });
            }
        }
        async function cancelar(id) {
            const confirm = await Swal.fire({
                title: 'Tem certeza?',
                text: 'Você quer cancelar este agendamento?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sim, cancelar',
                cancelButtonText: 'Não'
            });
        
            if (!confirm.isConfirmed) return;
        
            try {
                const res = await fetch('/aps/cancelar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ id })
                });
                const data = await res.json();
        
                if (res.ok) {
                    Swal.fire({ icon: 'success', title: 'Cancelado!', text: data.response });
                    carregarAgendas();
                } else {
                    Swal.fire({ icon: 'error', title: 'Erro', text: data.response });
                }
            } catch (err) {
                Swal.fire({ icon: 'error', title: 'Erro', text: 'Falha ao conectar ao servidor.' });
            }
        }


        
        window.onload = async () => {
            await verificarLogin();
            carregarAgendas();
        };

        window.onload = carregarAgendas;
    </script>
</body>
</html>
